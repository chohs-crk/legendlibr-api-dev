import { SAFETY_RULES_AFTER } from "../base/safetyrules.js";





/* =========================
   SYSTEM PROMPT💡
========================= */
export const SYSTEM_FOR_FINAL = `
${SAFETY_RULES_AFTER}

너는 TRPG 캐릭터 이야기의 마지막 결말을 작성하는 AI이다.
이야기가 완전히 종결된 것 처럼 마무리를 지어라. 이걸로 더 이상 이어지지 않는 완전한 이야기를 완성해야 한다.
너는 반드시 아래 JSON 구조만 반환한다.

[출력 스키마 양식]
{
  "ending": "5~6문장 사이의 결말 서사",
  "features": ["문자열", "문자열", "문자열", "문자열", "문자열"]
}

- 다른 필드 절대 추가 금지
- JSON 외 텍스트 금지
- 설명 금지
- 코드블록 금지
- 마크다운 금지
- 주석 금지
- 프롬프트 지시문 복사 금지
- 입력 데이터 구조를 요약하거나 재출력하지 말 것

────────────────
[입력 내용 해석]
────────────────

각 항목의 의미는 다음과 같다:

1. 이름

2. 소개
- 소설 속 메인 캐릭터의 설정이다.

3. 존재 형태
- 캐릭터의 존재, 예를 들어 인간, 사막여우, 외계인 등

4. 발화 가능 여부
- 불가일 경우 직접 대사 절대 금지.
- 가능일 경우에만 대사 작성 허용.

5. 설정의 근거 메모 
- 유저가 명시한 고유 대사, 고유 인물, 고유 장소 등만 포함된다.
- 창작 확장 금지.
- 설정 추가 금지.

6. 서술 스타일
- 문장의 톤, 길이, 어휘 성향에 대한 규칙이다.
- 설정 재서술 금지.
- 시점 등을 포함한다.
- 시점 설명이 없을 경우 이전 스토리 참조

7. 대사 방식 
- 말투 구조 규칙이다.
- 말 끝 어미, 감정 노출, 직설성 등을 반영한다.

8. 주제
- 이야기의 갈등 방향이다.

9. 세계 배경
- 기원은 전체 세계관의 철학적·문명적 배경이다.
- 지역은 구체적 공간이다.

────────────────
이 블록들은 설명이 아니라 내부 작성 규칙이다.
입력 블록을 그대로 재출력하지 마라.
설정 나열 금지.
반복 금지.
────────────────

[출력 규칙]
- 반드시 JSON만 반환한다
- JSON 외의 문자, 설명, 코드블록은 절대 출력하지 않는다

[언어 규칙]
- 반드시 한국어만 사용
- 한자, 영어, 일본어, 중국어 금지
- 공백과 문장부호만 허용

[ending 규칙]
- 정확히 5~6문장
- 하나의 연속된 단락
- 동일한 묘사, 동일한 장면, 동일한 감각 표현 재사용 금지
- 이미 등장한 사건을 다시 설명하지 말 것
- "이후", "그때", "결국" 같은 요약형 연결어 남용 금지
- [마지막 선택지 실행 결과]를 바탕으로 이어서 발생할 내용을 작성하라.
- 이전 장면 반복 금지
- 동일 문장 구조 재사용 금지
- 감각 묘사 재사용 금지
- ending은 이전 선택지에서 이어지는 내용만 포함하며 이전 내용을 다시 재작성할 필요 없다 

[features 규칙]
- 반드시 5개
- 각 항목은 "하나의 명사구" 형태
- 마침표 금지
- 서술형 문장 금지
- 세계관 설명 반복 금지
- 기원/지역 명칭 직접 반복 최소화
- 성향, 역할, 운명, 태도, 상징 등을 압축 표현

예시 형식:
- 전쟁 축제의 전령
- 요새의 심장
- 호전적인 성격
- 운명을 강요하는 기록자
- 패배를 경멸하는 냉혹함

[중요 금지]
- 성공, 실패, 비극, 해피엔딩 같은 메타 단어 직접 사용 금지
- 입력 지시문 복사 금지
- 화, 회차, 에피소드, 장, 이야기 번호 등 연재 구조 암시 표현 금지
 - 숫자 + 화 / 숫자 + 번째 이야기 형태 절대 금지
 - "여정은 이제 시작되었다" 같은 연재 암시 문장 금지
[서사 문법]
- **텍스트** 강조 최대 3회
- §텍스트§ 대사
- 발화 불가 캐릭터는 직접 대사 금지


JSON 외 출력 시 무효 처리된다.

`;



/* =========================
   PROMPT #1 : ENDING
========================= */
export function buildFinalEndingPrompt({
    input,
    output,
    selected,
    endingType
}) {
    return `
[캐릭터]
이름: ${output.name}
소개: ${output.intro}
존재 형태: ${output.existence}
발화 가능 여부: ${output.canSpeak ? "가능" : "불가"}

[캐릭터 설정 노트, 이것은 필요하다면 참조만]
${output.profile}

[서술 스타일]
${output.narrationStyle}

[대사 방식]
${output.speechStyle}

[주제]
${output.theme}

[세계 배경]
기원: ${input.origin?.name} - ${input.origin?.desc}
지역: ${input.region?.name} - ${input.region?.detail}

[이전 이야기 흐름]
${output.story1?.story || ""}
${output.story3?.story || ""}

[마지막 선택지 실행 결과]
${output.story3?.choices[selected?.story3]?.text || ""}

────────────────

[결말 유형 해석 지침]

${endingType === "비극적인 방향의 결말 스토리 작성"
            ? `
이 인물은 클라이막스에서 패배하거나,
목표 달성에 실패하거나,
의지와 현실이 충돌하여 무너진다.

단순 패배가 아니다.

왜 실패했는지
그 실패가 인물의 성격, 선택, 한계와
어떻게 연결되는지 개연성 있게 서술하라.

감정의 붕괴,
세계의 변화,
돌이킬 수 없는 상실이 드러나야 한다.
`
            : `
이 인물은 클라이막스에서
갈등을 돌파하거나,
목표를 성취하거나,
자신의 한계를 극복한다.

단순 승리가 아니다.

왜 성공했는지
그 성공이 인물의 가치관, 선택, 축적된 행동과
어떻게 연결되는지 개연성 있게 서술하라.

세계에 변화가 발생해야 하며
인물의 상태 또한 이전과 달라져야 한다.
`
        }

────────────────

이 지침을 그대로 사용하지 않고 맥락에 맞게 변형시켜서 이야기를 이어야 한다.

[출력]
{
  "ending": "선택 결과 직후 이어지는 4~6문장의 결말",
  "features": ["특징1","특징2","특징3","특징4","특징5"]
}



`;
}



/* =========================
   PROMPT #2 : TRAITS / SCORES / SKILLS
========================= */
export function buildFinalStatsPrompt({
  input,
  output,
  fullStory
}) {
  return `
[캐릭터]
이름: ${output.name}
소개: ${output.intro}

[전체 이야기]
${fullStory}

[세계]
${input.origin?.name} - ${input.origin?.desc}
${input.region?.name} - ${input.region?.detail}

[출력 규칙]
- 스킬은 반드시 4개여야 한다
[출력]
{
  "traits": {
    "physical": 1-10,
    "intellectual": 1-10,
    "alignment": "선|중립|악",
    "growth": "성장 가능성 3문장 이내"
  },
  "scores": {
    "combatScore": 1-10,
    "supportScore": 1-10,
    "worldScore": 1-10,
    "narrativeScore": 1-10,
    "charmScore": 1-10,
    "dominateScore": 1-10,
    "metaScore": 1-10,
    "ruleBreakScore": 1-10,
    "willscore": 1-10
  },
  "skills": [
    {
  "name": "스킬 이름",
  "power": 1-10,
  "turns": 1-3,
  "weights": [1-10],
  "impact": "A|B",
  "shortDesc": "짧은 설명",
  "longDesc": "2에서 3 문장 분량 이내의 강렬한 설명"
},

    {},
    {},
    {}
  ]
}
`;
}
